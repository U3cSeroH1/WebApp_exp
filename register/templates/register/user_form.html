{% extends "register/base.html" %}
{% block content %}

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 80%;
      width: 100%;
    }
  </style>

<ul>


  
  </ul>
<div id="map"></div>
<form action="" method="POST">
    {{ form.non_field_errors }}
    <table class="table">
                <tbody>
            {% for field in form %}

                <tr>
                    <th><label for="{{ field.id_for_label }}">{{ field.label }}</label></th>
                    <td>{{ field  }} {{ field.errors }} </td>
                </tr>
            {% endfor %}
                            <tr>
                                <script>
                                alert(response.your_surprise_txt);
                                </script>
                    <th><li>lat:lng </li></th>


                    <td><span id="lat"></span>:<span id="lng"></span>:<span id="geo"></span></td>

                </tr>
        </tbody>

    </table>
    {% csrf_token %}
    <button type="submit" class="btn btn-success btn-lg" >送信</button>
</form>
  {% load static %}

  <script src="{% static 'register/app1.js' %}"></script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGDQUmUwxTKDYbrOXlzLasHgeBfuPkVoA&callback=initMap" async defer></script>


<script>
    function getClickLatLng(lat_lng, map) {
      event.preventDefault();
//alert(JSON.stringify(obj));
      // 座標を表示
      document.getElementById('lat').textContent = lat_lng.lat();
      document.getElementById('lng').textContent = lat_lng.lng();
      a="{% url 'register:user_update' user.pk %}";
     
      var obj={
          lat:lat_lng.lat(),
          lng:lat_lng.lng(),
      };

    var geocoder = new google.maps.Geocoder;

    geocoder.geocode({'location': lat_lng}, function(results, status) {
          if (status === 'OK') {
            if (results[0]) {
              map.setZoom(16);
			  map.panTo(lat_lng);
              
			  window.alert(results[0].formatted_address + 'mother fucker');
          document.getElementById('geo').textContent = results[0].formatted_address;

    $.ajax({
            'url':'{% url "register:save_latlng" %}',
            'type':'POST',
            'data':{
                'lat':lat_lng.lat(),
                'lng':lat_lng.lng(),
                'geo': results[0].formatted_address,
                'lng_w':'afeeg',
                'lng_s':a,
                
            },
            'dataType':'json',
            
          csrfmiddlewaretoken: '{{ csrf_token }}',
            'success':function(response){  // 通信が成功したら動く処理で、引数には返ってきたレスポンスが入る
                //alert(response.aaa['lat']);  // レスポンスからデータを取り出してアラート
                //alert(iti);
            },
          'error':function(response){  // 通信が成功したら動く処理で、引数には返ってきたレスポンスが入る
                alert("st");  // レスポンスからデータを取り出してアラート
                alert(response.your_surprise_txt)
                alert(iti);
            },
        });

            } else {
              window.alert('No results found');
            }
          } else {
            window.alert('Geocoder failed due to: ' + status);
          }
        });


      alert(lat_lng);


                var marker = new google.maps.Marker({
                position: lat_lng,
                map: map,
                animation: google.maps.Animation.DROP,
                //icon: icon
                draggable: true,
                title: "Drag me!"

            });
  
      iti=lat_lng.lat()+","+lat_lng.lng();
 //     alert(obj.lat);
        
       
      var marker = new google.maps.Marker({
        position: lat_lng,
        map: map,

      });
}
</script>
<script>
    function initMap() {

      // マップの初期化
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 16,
        center: {lat: 33.232647, lng: 131.651055}
      });

      // クリックイベントを追加
      map.addListener('click', function(e) {
        getClickLatLng(e.latLng, map);
      });
    }
</script>


{% endblock %}
